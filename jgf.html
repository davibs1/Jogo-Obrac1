<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OBRAC — Jogo Digital - Educação Antirracista</title>
<style>
  :root{
    --bg:#071025;--card:#0f1724;--accent:#60a5fa;--muted:#94a3b8;--white:#eef2ff;
    --purple:#7c3aed;--orange:#f59e0b;--green:#10b981;--blue:#3b82f6;
  }
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;background:linear-gradient(180deg,#041329,#061029);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--white);display:flex;align-items:center;justify-content:center;padding:16px}
  .app{width:min(1100px,98vw);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:18px;box-shadow:0 10px 40px rgba(0,0,0,0.6)}
  h1{margin:0 0 8px 0;font-size:20px}
  .grid{display:grid;grid-template-columns:360px 1fr;gap:14px}
  .panel{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px}
  button{background:var(--accent);border:none;color:#04203a;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700}
  .secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
  input,select,textarea{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:var(--white)}
  .card-view{min-height:170px;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));display:flex;flex-direction:column;justify-content:flex-start;align-items:flex-start;gap:8px}
  .title{font-weight:800;letter-spacing:0.6px}
  .hint{color:var(--muted);font-size:14px}
  .players{display:flex;gap:8px;flex-wrap:wrap}
  .player{padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.02);min-width:140px}
  .die{padding:8px;border-radius:10px;background:rgba(255,255,255,0.01);display:flex;gap:8px;align-items:center}
  .options{display:flex;flex-direction:column;gap:8px;width:100%}
  .opt-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;text-align:left;color:var(--white);cursor:pointer}
  .opt-btn.disabled{opacity:0.5;cursor:not-allowed}
  .log{height:160px;overflow:auto;padding:8px;background:rgba(0,0,0,0.12);border-radius:8px;color:var(--muted);font-size:13px}
  .guess-row{display:flex;gap:8px;width:100%}
  .guess-row input{flex:1}
  footer{font-size:13px;color:var(--muted);margin-top:10px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="app" role="application" aria-label="Jogo OBRAC — Pontos">
    <h1>OBRAC — Jogo Digital - Educação Antirracista</h1>

    <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
      <input id="playerName" placeholder="Nome do jogador" />
      <button id="addPlayer" class="secondary">Adicionar jogador</button>
      <button id="newGame">Nova partida</button>
      <div style="margin-left:auto;color:var(--muted)">Meta de vitória: <strong id="goalLabel">40</strong> pts</div>
    </div>

    <div class="grid">
      <!-- esquerda: controle/jogadores/log -->
      <div class="panel">
        <div>
          <strong>Jogadores</strong>
          <div id="players" class="players" aria-live="polite"></div>
        </div>

        <div style="margin-top:10px">
          <strong>Placar</strong>
          <div id="scoreboard" style="margin-top:8px"></div>
        </div>

        <div style="margin-top:10px">
          <strong>Log</strong>
          <div id="log" class="log"></div>
        </div>
      </div>

      <!-- direita: ações, dado, carta -->
      <div class="panel" style="display:flex;flex-direction:column;gap:10px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="display:flex;gap:12px;align-items:center">
            <div class="die">
              <button id="rollDie">🎲 Rodar dado</button>
              <div id="dieFace" style="font-size:13px;color:var(--muted)">Face: —</div>
            </div>
            <div>
              <label style="font-size:13px;color:var(--muted)">Se o dado der "Escolha seu tema", selecione aqui:</label><br/>
              <select id="manualTheme" style="margin-top:6px">
                <option value="personalidades_negras">PERSONALIDADES NEGRAS (Roxo)</option>
                <option value="locais">LOCAIS (Laranja)</option>
                <option value="fatos_historicos">FATOS HISTÓRICOS (Verde)</option>
                <option value="obras">OBRAS (Azul)</option>
              </select>
            </div>
          </div>

          <div style="text-align:right">
            <div><strong>Turno:</strong> <span id="turnLabel">—</span></div>
            <div><strong>Pontuação:</strong> <span id="scoreLabel">0</span></div>
            <div style="margin-top:6px"><button id="endGame" class="secondary">Encerrar partida</button></div>
          </div>
        </div>

        <div class="card-view" id="cardView">
          <div class="title" id="cardTitle">—</div>
          <div class="hint" id="cardMeta">—</div>

          <div style="width:100%;display:flex;flex-direction:column;gap:6px;margin-top:6px">
            <div style="display:flex;gap:8px;align-items:center">
              <div style="flex:1">
                <div class="hint" id="currentHint">Pressione o dado para escolher um tema e tirar uma carta.</div>
              </div>
              <div style="display:flex;flex-direction:column;gap:6px">
                <div>Dicas usadas: <span id="hintsUsed">0</span></div>
                <div>Pontos (se acertar): <strong id="cardPoints">0</strong></div>
              </div>
            </div>
          </div>

          <!-- área de opções (só usada para cartas especiais) -->
          <div style="width:100%;margin-top:8px">
            <div id="options" class="options"></div>

            <!-- área de palpite livre (só para cartas normais) -->
            <div id="guessArea" style="margin-top:8px;display:none">
              <div class="guess-row">
                <input id="guessInput" placeholder="Digite seu palpite"/>
                <button id="submitGuess">Enviar</button>
              </div>
            </div>
          </div>

          <div style="width:100%;display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
            <button id="askHint" class="secondary">Pedir dica</button>
            <button id="reveal" class="secondary">Revelar (0 pts)</button>
          </div>
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="nextTurn" class="secondary">Próximo turno</button>
        </div>
      </div>
    </div>

    <footer style="margin-top:12px">OBRAC - Etapa II Fase II Componentes: Davi Barros, Evelyn Sales, Geovanni Santos e Isabelle Dutra</footer>
  </div>

<script>
/* ===========================
  Versão ajustada: alternativas SOMENTE nas cartas especiais.
  Cartas normais: palpite livre com tolerância (Levenshtein + normalização).
===========================*/

/* Configurações/estado (mantive os valores do último código) */
const GOAL = 40;
const POINT_MAP = [8,6,4,2,1];
const THEMES = [
  {key:'personalidades_negras', label:'PERSONALIDADES NEGRAS', color:'var(--purple)'},
  {key:'locais', label:'LOCAIS', color:'var(--orange)'},
  {key:'fatos_historicos', label:'FATOS HISTÓRICOS', color:'var(--green)'},
  {key:'obras', label:'OBRAS', color:'var(--blue)'}
];

let cardPools = { personalidades_negras: [], locais: [], fatos_historicos: [], obras: [] };
let players = []; // {name,score,lostTurn}
let currentPlayerIndex = 0;
let gameActive = false;
let currentCard = null;
let hintsUsed = 0;
let currentCardPoints = 0;
let dieLastFace = null;
let optionsLocked = false;

const $ = id => document.getElementById(id);
const logEl = $('log');
const playersEl = $('players');
const scoreboardEl = $('scoreboard');
const turnLabel = $('turnLabel');
const scoreLabel = $('scoreLabel');
const dieFaceEl = $('dieFace');
const cardTitle = $('cardTitle');
const cardMeta = $('cardMeta');
const currentHintEl = $('currentHint');
const hintsUsedEl = $('hintsUsed');
const cardPointsEl = $('cardPoints');
const optionsEl = $('options');
const guessArea = $('guessArea');
const guessInput = $('guessInput');

$('addPlayer').addEventListener('click', addPlayer);
$('newGame').addEventListener('click', startNewGame);
$('rollDie').addEventListener('click', rollDie);
$('askHint').addEventListener('click', askHint);
$('reveal').addEventListener('click', revealWord);
$('nextTurn').addEventListener('click', nextTurn);
$('endGame').addEventListener('click', endGame);
$('submitGuess').addEventListener('click', submitGuess);

/* util */
function log(msg){
  const now = new Date().toLocaleTimeString();
  logEl.innerHTML = `<div>[${now}] ${escapeHtml(msg)}</div>` + logEl.innerHTML;
}
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

function addPlayer(){
  const name = $('playerName').value.trim();
  if(!name) return alert('Digite um nome.');
  players.push({name,score:0,lostTurn:false});
  $('playerName').value='';
  renderPlayers();
  log(`Jogador adicionado: ${name}`);
}
function renderPlayers(){
  playersEl.innerHTML = '';
  players.forEach((p,i)=>{
    const div = document.createElement('div');
    div.className='player';
    div.innerHTML = `<strong>${p.name}</strong><div style="font-size:13px;color:var(--muted)">Pontos: <span id="p-${i}">${p.score}</span> • Status: ${p.lostTurn ? '<em>Perdeu vez</em>' : 'OK'}</div>`;
    playersEl.appendChild(div);
  });
  renderScoreboard();
  updateStatus();
}
function renderScoreboard(){
  scoreboardEl.innerHTML = players.map((p,i)=>`<div style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.03)"><strong>${p.name}</strong> — ${p.score} pts</div>`).join('');
}

/* Carrega cartas (mesmo conteúdo do código anterior) */
function loadAllCards(){
  const all = [
    // PERSONALIDADES NEGRAS (normais)
    {"theme":"personalidades_negras","type":"normal","word":"Pelé","hints":["conquistei três copas do mundo","sou o Rei do futebol","joguei pelo Santos Futebol Clube","também joguei pela Seleção Brasileira","morri em 2022","meu nome tem 4 letras"]},
    {"theme":"personalidades_negras","type":"normal","word":"Djamila Ribeiro","hints":["Sou uma filósofa, escritora e ativista","Escrevi o Pequeno Manual Antirracista","atuo no feminismo negro","meu sobrenome é Ribeiro","fui secretária de Direitos Humanos em SP","meu nome começa com “D”"]},
    {"theme":"personalidades_negras","type":"normal","word":"Michael Jackson","hints":["sou conhecido como o “Rei do Pop”","morri em 2009","“moonwalk” é o meu passo de dança","eu tinha vitiligo","muitos não me vêem como uma figura negra","Jackson é o meu sobrenome"]},
    {"theme":"personalidades_negras","type":"normal","word":"Carolina Maria de Jesus","hints":["meu livro mais famoso é um diário","Jesus é o meu sobrenome","tenho nome composto","sou catadora de papel","aprendi a ler e escrever com os jornais coletados","sou mãe de três filhos"]},
    {"theme":"personalidades_negras","type":"normal","word":"Zumbi dos Palmares","hints":["nasci no Quilombo dos Palmares","fui líder da resistência negra","lutei contra a escravidão","minha cabeça foi exposta em praça pública","Dia da Consciência Negra (22 de novembro)","o meu nome tem “Zumbi”"]},
    {"theme":"personalidades_negras","type":"normal","word":"Machado de Assis","hints":["sou o maior escritor brasileiro","ferramenta = nome","deixei um legado ímpar na literatura","a minha negritude foi negada","Fundei a Academia Brasileira de Letras","também sou o bruxo do Cosme Velho"]},
    {"theme":"personalidades_negras","type":"normal","word":"Luís Gama","hints":["fui vendido como escravo","atuei como advogado","meu sobrenome tem “Gama”","fui poeta e advogado","meu nome quatro letras","“L” é a primeira letra do meu nome"]},
    {"theme":"personalidades_negras","type":"normal","word":"Milton Santos","hints":["estudei sobre a globalização","meu sobrenome é “Santos”","ganhei o “Nobel da Geografia”","“M” é a primeira letra do meu nome","fui professor em vários países","sou o maior geógrafo do Brasil"]},
    {"theme":"personalidades_negras","type":"normal","word":"Gilberto Gil","hints":["sou um dos maiores nomes da MPB","participei do movimento Tropicália","minha carreira tem mais de 50 anos","meu sobrenome é Gil","“Desde Que O Samba É Samba”","Já ganhei Grammy Awards"]},
    {"theme":"personalidades_negras","type":"normal","word":"Elza Soares","hints":["sou uma cantora brasileira","princesa do filme Frozen","meu sobrenome é Soares","sou considerada a rainha do samba","canto sobre empoderamento feminino","morri em 2022"]},
    {"theme":"personalidades_negras","type":"normal","word":"Marina Silva","hints":["superei a pobreza e o analfabetismo","fui senadora e ministra do meio ambiente","meu sobrenome é Silva","disputei a Presidência da República","“M” é a primeira letra do meu nome","TROQUE DE LUGAR"]},
    {"theme":"personalidades_negras","type":"normal","word":"Glória Maria","hints":["fui jornalista e apresentadora","apresentei o Jornal Nacional","recebi prêmios importantes da televisão","meu nome é composto","o primeiro nome começa com “G”","meu segundo nome é Maria"]},
    {"theme":"personalidades_negras","type":"normal","word":"Iza","hints":["sou uma cantora brasileira","tenho músicas como Dona de Mim e Pesadão","nasci no Rio de Janeiro","fui jurada no The Voice Brasil.","meu nome é Isabela","sou conhecida pelo meu apelido"]},
    {"theme":"personalidades_negras","type":"normal","word":"Beatriz Souza","hints":["sou uma judoca brasileira","fui campeã pan-americana","compito na categoria +78 kg","inspiro jovens atletas e mulheres","meu apelido é Bia","meu sobrenome é Souza"]},
    {"theme":"personalidades_negras","type":"normal","word":"Vinícius Junior","hints":["sou um jogador de futebol brasileiro","jogo pela Seleção Brasileira","enfrento diversos ataques racistas","jogo pelo Real Madrid","meu apelido é mais famoso","inspiro jovens atletas"]},
    {"theme":"personalidades_negras","type":"normal","word":"Rebeca Andrade","hints":["sou uma ginasta","fui a 1° a ganhar medalha olímpica no individual geral","conquistei ouro no salto","também sou campeã mundial","recebi prêmios de melhor atleta","meu sobrenome é Andrade"]},
    {"theme":"personalidades_negras","type":"normal","word":"Ronaldinho Gaúcho","hints":["joguei no clube do Grêmio","fui considerado o Melhor Jogador do Mundo","meu nome é Ronaldo","sou um jogador de futebol brasileiro","vários gols meus foram icônicos","sou conhecido pelo meu sorriso"]},
    {"theme":"personalidades_negras","type":"normal","word":"Djavan","hints":["“Oceano” é uma das minhas músicas","sou reconhecido internacionalmente","recebi vários prêmios musicais","sou um dos maiores nomes da MPB","componho letras poéticas e complexas","meu nome começa com “D”"]},
    {"theme":"personalidades_negras","type":"normal","word":"Tim Maia","hints":["meu apelido é uma rede de Internet","“Azul da Cor do Mar” é a minha música","meu sobrenome é “Maia”","sou muito conhecido pelo MPB","morri em 1998","influencio diferentes gerações"]},
    {"theme":"personalidades_negras","type":"normal","word":"Péricles","hints":["era vocalista do grupo Exaltasamba","“Deixa Acontecer” é a minha música","sou conhecido pelo pagode romântico","participei do The Voice Brasil","meu nome começa com “P”","faço música há mais de 30 anos"]},

    // LOCAIS (normais)
    {"theme":"locais","type":"normal","word":"Museu Afro Brasil","hints":["Moro em São Paulo","Nasci em 2004.","Emanoel Araújo é próximo de mim.","Dizem que vivo de passado.","Dou ênfase na valorização de aspectos da cultura de matriz africana.","Sou histórico, artístico e etnológico"]},
    {"theme":"locais","type":"normal","word":"Quilombo da Rasa","hints":["Sou uma comunidade.","Moro no Rio de Janeiro.","Fui criada por escravizadas.","Me formei através da busca de terras para o cultivo.","Sofro com a especulação imobiliária e a falta de reconhecimento de seus direitos à terra.","Quilombo está no meu nome."]},
    {"theme":"locais","type":"normal","word":"Roda de Samba da Pedra do Sal","hints":["Surgi no Rio de Janeiro.","Originei-me no século XIX.","Preservo a herança africana.","Roda está no meu nome.","Sou um símbolo de resistência cultural.","Sou considerada o berço do samba."]},
    {"theme":"locais","type":"normal","word":"Quilombo dos Palmares","hints":["Sou uma comunidade autônoma.","Nasci em Alagoas.","Originei-me no final do século XVI.","Fui destruída.","Zumbi é um dos meus líderes","Tornei-me um símbolo de resistência."]},
    {"theme":"locais","type":"normal","word":"Pelourinho","hints":["Sou um ponto turístico.","Moro em Salvador.","Sou conhecido pela arquitetura colonial barroca.","Meu nome faz referência ao lugar que criminosos e escravizados eram amarrados e punidos.","Por um tempo, fui um centro administrativo e comercial.","Fui erguido no século XVI."]},
    {"theme":"locais","type":"normal","word":"Soweto","hints":["Sou uma cidade.","Me tornei um símbolo da luta contra o regime do apartheid.","Nasci em 1963.","Meu objetivo era agrupar bairros destinados aos negros.","Moro na África do Sul.","Sou rica em cultura e história."]},
    {"theme":"locais","type":"normal","word":"Cachoeira","hints":["Estou localizada na Bahia.","Sou um centro de preservação da memória e das tradições ancestrais.","Minha cidade é um importante ponto comercial.","Mantenho viva a cultura africana.","Sou conhecida pela força dos meus rituais religiosos.","Minha cultura é o barroco."]},
    {"theme":"locais","type":"normal","word":"Museu Percurso do Negro","hints":["Sou um museu.","Estou localizado em Porto Alegre.","Rememorizo a história do povo negro.","Pessoas me visitam.","Interligo marcos históricos.","Nasci em 2011."]},
    {"theme":"locais","type":"normal","word":"Cafuá das Mercês","hints":["Sou um museu.","Resido no Maranhão.","Fui originado no século XVIII.","Era um depósito de escravos para comercialização.","Divulgo e preservo a história afrodescendente do meu estado.","Possuo peças e documentos relacionados à história da escravidão no Brasil."]},
    {"theme":"locais","type":"normal","word":"Museu da Abolição","hints":["Sou um museu.","Moro em Recife.","Nasci em 1957.","Meu objetivo é valorizar à cultura e a história dos afrodescendentes.","Possuo objetos do antigo cotidiano de senhores e escravos.","A arte contemporânea e objetos da etnia africana, são próximos de mim."]},
    {"theme":"locais","type":"normal","word":"Praça dos Orixás","hints":["Praça dos Orixás (referência cultural)","Local de manifestações religiosas e culturais","Ligada à religiosidade afro-brasileira","Ponto de encontro comunitário","Eventos religiosos e culturais ocorrem aqui","Memória e ancestralidade"]},
    {"theme":"locais","type":"normal","word":"Centro Cultural Casa África","hints":["Sou um Centro Cultural.","Meu objetivo é preservar e divulgar uma cultura bastante conhecida.","Nasci em 2003.","Promovo palestras, exposições e eventos turísticos.","Estou localizado em Belo Horizonte.","Nas sextas e sábados ofereço gastronomia e música."]},
    {"theme":"locais","type":"normal","word":"Casa dos Contos de Ouro Preto","hints":["Sou um museu.","Preservo e exponho a história econômica e fiscal do Brasil.","Abrigo uma senzala preservada.","Sou um marco do barroco mineiro.","Estou localizado em Ouro Preto.","Fui originado em 1974."]},
    {"theme":"locais","type":"normal","word":"Igreja de Nossa Senhora do Rosário dos homens pretos","hints":["Estou localizada no Rio Grande do Norte.","Sou uma igreja.","Meu objetivo é, no período colonial, promover um espaço acessível a um grupo específico.","Fui fundada em 1713.","Escravos negros me fundaram.","Sou um espaço de resistência e sociabilidade."]},
    {"theme":"locais","type":"normal","word":"Escola de samba Vai Vai","hints":["Sou conhecida como escola do povo.","Estou localizada em São Paulo.","Fui fundada em 1930.","Sou a maior campeã do carnaval.","Clarício Gonçalves é próximo de mim.","Sou um símbolo da resistência da periferia e da diáspora africana."]},
    {"theme":"locais","type":"normal","word":"Praça Onze","hints":["Meu nome foi herdado de um antigo logradouro.","Estou localizada no Rio de Janeiro.","Antes, eu era conhecida como berço do Samba, que reunia comunidades negras e judaicas.","Meu nome é em homenagem à data da vitória brasileira na Batalha do Riachuelo.","Minha área foi desapropriada e extinta, mas minha memória cultural continua viva.","Sofri uma modernização em 1940."]},
    {"theme":"locais","type":"normal","word":"Cais do Valongo","hints":["Cais do Valongo — porto histórico.","Ligado ao tráfico negreiro no Rio de Janeiro.","Local de chegada forçada de africanos escravizados.","Importante marco da memória negra no Brasil.","Reconhecido como patrimônio.","Símbolo de memória e lutas."]},
    {"theme":"locais","type":"normal","word":"Cidade de Lagos","hints":["Sou uma cidade.","Estou localizada em Portugal.","Sou um dos pontos de partida das grandes navegações portuguesas.","Possuo um rico património arquitetónico.","Na minha cultura, tenho traços da civilização árabe.","Sofri um terremoto devastador em 1755."]},
    {"theme":"locais","type":"normal","word":"Vale do Rio Niger","hints":["Sou um Rio.","Moro na Africa Ocidental.","Possuo uma grande extensão.","Me tornei um centro de civilizações antigas.","Minha criação foi influenciada por colonizadores europeus.","Sou um local de intercâmbio cultural e histórico."]},
    {"theme":"locais","type":"normal","word":"Praça da Sé","hints":["Resido em São Paulo.","Originei-me quando um lago foi reformado.","Sou um espaço público.","Estou no banco imobiliário.","Sou uma praça.","Possui uma catedral com meu nome."]},

    // FATOS HISTÓRICOS (normais)
    {"theme":"fatos_historicos","type":"normal","word":"Marcha Nacional das Mulheres Negras","hints":["Ocorri em 2015.","Sou um movimento de organização política e social.","Mulheres negras me criaram.","Aconteci em Brasília.","Meu objetivo é denunciar o racismo e a desigualdade social.","Marcha é uma parte do meu nome."]},
    {"theme":"fatos_historicos","type":"normal","word":"Aprovação da Lei Afonso Arinos","hints":["Ocorri em 1951.","O Congresso Nacional é próximo de mim.","Sou um marco para a luta antirracista.","Fui criada devido a uma situação com uma bailarina afro-americana.","Sou uma aprovação.","Meu nome é composto por um substantivo próprio."]},
    {"theme":"fatos_historicos","type":"normal","word":"Revolta dos alfaiates","hints":["Sou uma revolta.","Ocorri em Salvador.","A independência do Haiti e uma crise social e econômica deram origem a mim.","Aconteci em 1798.","A publicação de panfletos foi fundamental na organização da minha origem.","Classe pobre, soldados e a elite, me lideraram."]},
    {"theme":"fatos_historicos","type":"normal","word":"Promulgação da Lei Euzébio de Queiroz","hints":["Ocorri em 1850.","Lei compõe o meu nome.","Proibi definitivamente o tráfico de africanos escravizados.","Aconteci no Rio de Janeiro.","D. Pedro II é próximo de mim.","Fui resultado da intensa pressão do Reino Unido."]},
    {"theme":"fatos_historicos","type":"normal","word":"Dia Nacional da Consciência Negra","hints":["Celebro a resistência.","Aconteço em Novembro.","Relembro a luta dos negros contra a opressão.","Sou um feriado nacional.","Ocorro no Brasil.","Fui criado por meio de uma lei."]},
    {"theme":"fatos_historicos","type":"normal","word":"Revolta da Chibata","hints":["Sou uma revolta.","Ocorri no Rio de Janeiro.","Sou uma rebelião militar.","Fui originada em 1910.","Aconteci no dia que um presidente iria ser recebido.","Marinheiros me compõem."]},
    {"theme":"fatos_historicos","type":"normal","word":"Morte de Zumbi dos Palmares","hints":["Aconteci em 1695.","Palmares faz parte do meu nome.","A decapitação me originou.","Aconteci na Serra da Barriga.","Tentaram fazer com que eu originasse diversas vezes.","Um líder é relacionado a mim."]},
    {"theme":"fatos_historicos","type":"normal","word":"Revolta dos Malês","hints":["Sou uma revolta.","Aconteci em Salvador","Ocorri em 1835.","Meu objetivo final era a libertação e a liberdade religiosa.","Sou a maior revolta de escravizados da história brasileira.","Alguns dos envolvidos em minha origem, foram punidos severamente."]},
    {"theme":"fatos_historicos","type":"normal","word":"Movimento Negro Unificado","hints":["Sou uma organização ativista.","Ocorri em 1978.","Aconteci em São Paulo.","Meu objetivo é combater o racismo.","Fui motivada por eventos de discriminação.","Sou a maior entidade negra da America Latina."]},
    {"theme":"fatos_historicos","type":"normal","word":"1° Conferência Nacional da Promoção da Igualidade Racial","hints":["Ocorri em Brasília.","Aconteci em 2005.","Sou um evento.","Meu objetivo é combater o racismo e outras formas de intolerância.","Promovi o desenvolvimento de populações tradicionais.","Valorizo a diversidade cultural brasileira."]},
    {"theme":"fatos_historicos","type":"normal","word":"Criação da Frente Negra Brasileira","hints":["Meu objetivo é reivindicar melhores condições de vida para os negros.","Ocorri em 1931.","Aconteci em São Paulo.","Meu objetivo é organizar a igualdade de direitos.","Sou a primeira organização negra do Brasil.","Acredito que a solução para o país é um governo forte que tenha compromisso com a nação."]},
    {"theme":"fatos_historicos","type":"normal","word":"Apartheid na África do Sul","hints":["Sou um regime político.","Ocorri entre 1948 e 1994.","Aconteci na África do Sul.","Fui sustentado pelo Partido Nacional e por um partido de extrema-direita.","Fiz com que um país sofresse uma forte pressão internacional.","Não fui criado por uma única pessoa, mas sim por um sistema legal imposto pelas elites brancas."]},
    {"theme":"fatos_historicos","type":"normal","word":"Movimento Black Power","hints":["Aconteci nos Estados Unidos.","Ocorri no ano de 1960.","Sou um movimento político cultural.","Promovo a valorização da cultura e da beleza negra.","Reinvidico a igualdade racial.","Surgi a partir de outro movimento."]},
    {"theme":"fatos_historicos","type":"normal","word":"Abolição da Escravidão nos EUA","hints":["Sou um processo legalizado.","Ocorri nos Estados Unidos.","Fui originada através da a ratificação da 13ª Emenda à Constituição.","Aconteci no ano de 1865.","Acabei com um dos maiores sistemas de produção escravistas.","Sou a anulação de algo cruel."]},
    {"theme":"fatos_historicos","type":"normal","word":"Panteras Negras","hints":["Sou uma organização socialista.","Ocorri nos Estados Unidos.","Aconteci em 1966.","Bobby Seale e Huey Newton são responsáveis por mim.","Surgi da insatisfação com as táticas dos direitos civis.","Implantei programas comunitários."]},
    {"theme":"fatos_historicos","type":"normal","word":"Massacre de Soweto","hints":["Sou fruto da rebelião negra.","Ocorri na África do Sul.","Aconteci em 1976.","15.000 pessoas morreram por minha causa.","Fui desencadeado pela repressão policial à passeata.","Sou um episódio sangrento."]},
    {"theme":"fatos_historicos","type":"normal","word":"Criação do Estatuto de Igualdade Racial","hints":["Fui originado em Brasília.","Aconteci em 2010.","Meu objetivo é combater a discriminação racial.","Igualdade está presente no meu nome.","Sou um Estatuto.","Quero assegurar o acesso pleno aos direitos fundamentais."]},

    // OBRAS (normais)
    {"theme":"obras","type":"normal","word":"Quarto de Despejo","hints":["eu fui publicado em 1960","o sobrenome da autora é Jesus","sou um livro autobiográfico","a escritora era moradora da favela","tenho vários erros ortográficos","a autora era catadora de papel"]},
    {"theme":"obras","type":"normal","word":"Olhos D'água","hints":["meu nome tem a palavra \"água\"","o povo afro-brasileiro é o meu foco","no meu título há um órgão da visão","sou um livro com 15 contos","a autora se chama Conceição Evaristo","na capa há uma olho castanho."]},
    {"theme":"obras","type":"normal","word":"Pequeno Manual Antirracista","hints":["violência, branquitude e cultura é o meu foco","sou um livro/manual","Djamila Ribeiro é a autora","AVANCE DUAS CASAS","a escritora é feminista, filósofa e ativista","a minha capa é amarela"]},
    {"theme":"obras","type":"normal","word":"Rap da Felicidade","hints":["Cidinho e Doca são os cantores","meu gênero não é o Rap, embora tenha no título","abordo as desigualdades que há nas favelas","busco a minha felicidade","“Eu só quero é ser feliz…”","foco na violência do Rio de Janeiro"]},
    {"theme":"obras","type":"normal","word":"AmarElo","hints":["o meu nome é uma cor primária","sou uma canção pop","tem relação com o setembro amarelo","mostro a realidade das favelas","“amar é um elo…”","Emicida é o cantor da música"]},
    {"theme":"obras","type":"normal","word":"King Richard: Criando Campeãs","hints":["um pai cria as campeãs do tênis","nome do pai: Richard Williams","no título tem a palavra rei em inglês","relato a história das irmãs Willams","Richard cria as lendas do tênis","sou um filme baseado em fatos reais"]},
    {"theme":"obras","type":"normal","word":"O Menino que Descobriu o Vento","hints":["narro a construção da turbina eólica","mostro a realidade da fome e seca","filme baseado em fatos reais","no título tem a palavra “vento”","ocorreu no vilarejo do Malawi","um garoto construiu uma turbina"]},
    {"theme":"obras","type":"normal","word":"Pantera Negra","hints":["sou um filme da Marvel","conto a história de um Super-herói","também sou um animal","velocidade é o meu poder","meu traje é preto com pedras prateadas","também sou o mascote do IF (CNAT)"]},
    {"theme":"obras","type":"normal","word":"Cidade de Deus","hints":["o meu nome é o mesmo de uma favela carioca","Buscapé é o narrador","mostro a desigualdade e a violência","a palavra “Deus” está no meu título","sou um filme baseado em fatos reais","Fui indicado ao Oscar"]},
    {"theme":"obras","type":"normal","word":"À Procura da Felicidade","hints":["sou um filme baseado em fatos reais","no meu título tem um tipo de sentimento","um pai está à procura de algo","a desigualdade financeira é o meu foco","sou estrelado por Will Smith e Jaden Smith","mostro que o abandono não é a solução"]},
    {"theme":"obras","type":"normal","word":"Estrelas Além do Tempo","hints":["as protagonistas são matemáticas afro-americanas","mostro o preconceito racial e de gênero","mulheres que mudaram a NASA","sou um filme baseado em fatos reais","“esse banheiro não é para pessoas negras…”","no título tem a palavra “Estrelas”"]},
    {"theme":"obras","type":"normal","word":"A Princesa e o Sapo","hints":["sou um filme infantil da Disney","o beijo transforma as pessoas","o protagonista é um sapo","o nome da princesa é Tiana","no meu título há dois personagens","mostro a vida de uma mulher trabalhadora"]},
    {"theme":"obras","type":"normal","word":"Vidas Negras Importam","hints":["o meu gênero é o samba","refrão: “uma vida negra importa”","refrão + plural = título","a letra denuncia o racismo estrutural","sou uma resposta ao movimento Black Lives Matter","no meu título tem a palavra “Vidas”"]},
    {"theme":"obras","type":"normal","word":"Navio negreiro","hints":["sou uma poesia abolicionista em música","falo sobre o tráfico negreiro","no meu título tem a palavra “navio”","Descrevo a travessia dos negros africano","Navio + negreiro = título","mostro o sofrimento dos escravos"]},
    {"theme":"obras","type":"normal","word":"O Cortiço","hints":["Sou um livro de romance naturalista","mostro a exploração e o preconceito racial","Meu autor é Aluísio Azevedo","sou um cortiço no Rio de Janeiro.","o meu título tem a palavra “Cortiço”","João Romão e Bertoleza são os personagens principais"]},
    {"theme":"obras","type":"normal","word":"This is America","hints":["sou uma música do autor Childish Gambino.","o refrão é “This is America”","retraro a violência e o racismo","foco das desigualdades do EUA","refrão = título","meu título denuncia os americanos"]},
    {"theme":"obras","type":"normal","word":"Cotas","hints":["mostro a desigualdade social e racial","Meu autor e intérprete é o Criolo","Trago a importância das cotas raciais","a letra critica os preconceitos raciais","aponto uma forte mensagem política","título = cotas"]},
    {"theme":"obras","type":"normal","word":"12 Anos de Escravidão","hints":["Mostro a crueldade da escravidão nos EUA","Ganhei o Oscar de Melhor Filme","no meu título tem a palavra “Escravidão”","o personagem ficou 12 anos escravizado","sou um filme baseado em fatos reais","12 anos + Escravidão = título"]},
    {"theme":"obras","type":"normal","word":"Pelas Ruas do Brasil","hints":["mostro as desigualdades nas ruas brasileiras","sou um livro de crônicas e relatos","trago as lutas e a resistência dos brasileiros","o título fala de andar pelas cidades","meu autor é Eliane Brum","Pela Ruas + Brasil = título"]},
    {"theme":"obras","type":"normal","word":"Que Horas Ela Volta?","hints":["mostro a desigualdade entre patrões e empregados","o título faz uma pergunta sobre horário","questiono as regras de classe e os privilégios.","a protagonista se chama Val","de forma crítica e sensível trago as ≠ sociais","horário + ela volta? = título"]},
  ];

  // reset pools and push
  cardPools = { personalidades_negras: [], locais: [], fatos_historicos: [], obras: [] };
  all.forEach(c => cardPools[c.theme].push(c));

  // especiais (um em cada pilha) — intensificados
  const special1 = {
    theme:'locais', type:'special', title:'BÚSSOLA LIBERTADORA',
    question:null, choices:null, answer:null,
    effect:{kind:'instant', value:+10, text:'+10 pts para quem tirou a carta (Bússola Libertadora)'}
  };
  const special2 = {
    theme:'personalidades_negras', type:'special', title:'MAPA COM MEMÓRIA',
    question:'De que forma incluir símbolos da cultura afro-brasileira em mapas escolares pode promover uma educação antirracista?',
    choices:[
      'Valoriza territórios, tradições e referências culturais negras, antes invisibilizadas.',
      'Padroniza símbolos sem relação cultural',
      'Aumenta o custo da produção de mapas',
      'Substitui a geografia regional por temas globais'
    ],
    answer:0,
    effect:{kind:'map_memory', winValue:+15, loseValue:-5, text:'+15 pts para quem respondeu; -5 para os outros quando a cor escolhida aparecer'}
  };
  const special3 = {
    theme:'fatos_historicos', type:'special', title:'OBJETO LIBERTADOR',
    question:'Qual instrumento substituiu a observação das estrelas na navegação moderna?',
    choices:['Bússola','Astrolábio','Mapa celeste','Régua náutica'],
    answer:0,
    effect:{kind:'first_green_penalty', penalty:-20, text:'O primeiro (entre os outros) que tirar verde perde -20 pts'}
  };
  const special4 = {
    theme:'obras', type:'special', title:'LUZ DA RESISTÊNCIA',
    question:'Como a orientação foi usada tanto na navegação quanto na fuga de pessoas escravizadas?',
    choices:[
      'No tráfico negreiro pelos colonizadores e os astros para guiar as fugas dos escravizados.',
      'Apenas instrumentos mecânicos eram usados na navegação moderna.',
      'Somente mapas foram relevantes; astros não tiveram papel.',
      'A orientação não teve relação com fugas ou navegação.'
    ],
    answer:0,
    effect:{kind:'color_effect', mapping:{
      0:{type:'penalize_other', value:-15, text:'Roxo → escolha alguém para perder -15 pts'},
      1:{type:'swap_with_leader', text:'Laranja → troque pontuação com o jogador mais próximo da vitória'},
      2:{type:'gain_self', value:+20, text:'Verde → você ganha +20 pts'},
      3:{type:'lose_turn', text:'Azul → escolha alguém para perder a vez (próxima rodada)'}
    }}
  };

  cardPools['locais'].push(special1);
  cardPools['personalidades_negras'].push(special2);
  cardPools['fatos_historicos'].push(special3);
  cardPools['obras'].push(special4);

  log('Cartas carregadas (incluindo 4 especiais).');
}

/* Dado */
function rollDie(){
  if(!gameActive) return alert('Inicie uma nova partida (Nova partida) e adicione jogadores.');
  const player = players[currentPlayerIndex];
  if(player.lostTurn){
    player.lostTurn = false;
    log(`${player.name} perdeu a vez (flag). A vez foi consumida.`);
    nextTurn();
    return;
  }
  optionsLocked = false;
  clearCardDisplay();
  const face = Math.floor(Math.random()*6);
  dieLastFace = face;
  showDieFace(face);
  if(face >=0 && face <=3){
    const themeKey = THEMES[face].key;
    log(`${player.name} tirou o dado → tema: ${THEMES[face].label}`);
    drawCard(themeKey);
  } else if(face === 4){
    player.lostTurn = true;
    log(`${player.name} tirou PERDE A VEZ → perderá a próxima vez.`);
    updateStatus();
    setTimeout(nextTurn, 700);
  } else {
    const theme = $('manualTheme').value;
    const label = THEMES.find(t=>t.key===theme)?.label || theme;
    log(`${player.name} tirou ESCOLHA SEU TEMA → escolheu ${label}`);
    drawCard(theme);
  }
}
function showDieFace(face){
  if(face>=0 && face<=3){
    dieFaceEl.innerHTML = `Face: ${THEMES[face].label} <span style="display:inline-block;width:14px;height:14px;border-radius:4px;background:${THEMES[face].color};margin-left:8px"></span>`;
  } else if(face===4) dieFaceEl.textContent = 'Face: PERDE A VEZ';
  else dieFaceEl.textContent = 'Face: ESCOLHA SEU TEMA';
}

/* Sorteio da carta; remove do baralho; prepara view */
function drawCard(themeKey){
  const pool = cardPools[themeKey] || [];
  if(pool.length === 0) { alert('Sem cartas nesse tema.'); return; }
  const idx = Math.floor(Math.random()*pool.length);
  currentCard = pool.splice(idx,1)[0];
  hintsUsed = 0;
  currentCardPoints = 0;
  prepareCardView(currentCard, themeKey);
}

function prepareCardView(card, themeKey){
  optionsLocked = false;
  cardTitle.textContent = card.type === 'special' ? `Carta Especial — ${card.title || 'Especial'}` : `Tema — ${themeKey.toUpperCase().replace('_',' ')}`;
  cardMeta.textContent = card.type === 'special' ? (card.effect?.text || '') : `Adivinhe: escreva o nome da palavra em questão`;
  // clear areas
  optionsEl.innerHTML = '';
  guessArea.style.display = 'none';
  // normal cards -> show first hint (if exists), show guess area
  if(card.type === 'normal'){
    guessArea.style.display = 'block';
    if(card.hints && card.hints.length > 0){
      hintsUsed = 1;
      currentHintEl.textContent = card.hints[0];
    } else {
      hintsUsed = 0;
      currentHintEl.textContent = 'Sem dicas disponíveis.';
    }
    currentCardPoints = computePoints();
    hintsUsedEl.textContent = hintsUsed;
    cardPointsEl.textContent = currentCardPoints;
  } else {
    // special: show question and multiple choice buttons (single attempt)
    guessArea.style.display = 'none';
    if(card.question){
      currentHintEl.textContent = card.question;
    } else {
      currentHintEl.textContent = card.effect?.text || '';
    }
    // build choices only for specials that have choices; instant specials get a single "Ativar" button
    if(card.choices && card.choices.length){
      renderOptionsForSpecial(card, card.choices, card.answer);
    } else if(card.question && (!card.choices || card.choices.length === 0)){
      // fallback: show 4 generic options (not ideal but keeps UI consistent)
      const fallback = ['Opção A','Opção B','Opção C','Opção D'];
      renderOptionsForSpecial(card, fallback, card.answer !== undefined ? card.answer : 0);
    } else {
      // instant effect
      renderOptionsForSpecial(card, ['Ativar carta (sem escolha múltipla)'], 0, true);
    }
  }
  updateStatus();
}

/* Render multiple-choice for special cards only */
function renderOptionsForSpecial(card, choices, correctIndex, instant=false){
  optionsEl.innerHTML = '';
  choices.forEach((c,i)=>{
    const btn = document.createElement('button');
    btn.className = 'opt-btn';
    btn.textContent = c;
    btn.disabled = false;
    btn.addEventListener('click', ()=>{
      if(optionsLocked) return;
      optionsLocked = true;
      if(instant){
        log(`${players[currentPlayerIndex].name} ativou a carta especial "${card.title}".`);
        applySpecialEffect(card, true);
      } else {
        const correct = (i === correctIndex);
        if(correct){
          log(`${players[currentPlayerIndex].name} escolheu a alternativa correta na carta especial "${card.title}".`);
          applySpecialEffect(card, true);
        } else {
          log(`${players[currentPlayerIndex].name} escolheu alternativa INCORRETA na carta especial "${card.title}".`);
          // incorrect -> no effect; next player's turn
          setTimeout(nextTurn, 600);
        }
      }
    });
    optionsEl.appendChild(btn);
  });
  const note = document.createElement('div');
  note.style.color = 'var(--muted)';
  note.style.fontSize = '13px';
  note.style.marginTop = '6px';
  note.textContent = 'Nas cartas especiais: escolha apenas UMA opção (uma chance).';
  optionsEl.appendChild(note);
}

/* Palpite livre para cartas normais */
function submitGuess(){
  if(!currentCard) return alert('Gire o dado e tire uma carta primeiro.');
  if(currentCard.type !== 'normal') return alert('Este campo é apenas para cartas normais. Use as alternativas para cartas especiais.');
  const guessRaw = guessInput.value.trim();
  if(!guessRaw) return alert('Digite seu palpite.');
  const player = players[currentPlayerIndex];
  const target = currentCard.word || '';
  const ok = tolerantMatch(guessRaw, target);
  if(ok){
    const pts = computePoints();
    player.score += pts;
    log(`${player.name} acertou "${target}" e ganhou +${pts} pts.`);
    checkVictory(player);
    guessInput.value='';
    renderPlayers();
    setTimeout(nextTurn,600);
  } else {
    log(`${player.name} errou (digitou "${guessRaw}").`);
    guessInput.value='';
    // allow retries for normal cards (user didn't restrict), but you can change this if you want one attempt only for normals.
    setTimeout(nextTurn,600);
  }
  updateStatus();
}

/* Dicas e revelar (normais) */
function askHint(){
  if(!currentCard) return alert('Gire o dado para tirar uma carta primeiro.');
  if(currentCard.type === 'special'){ alert('Cartas especiais não têm dicas sequenciais. Responda pela alternativa.'); return; }
  const hints = currentCard.hints || [];
  if(hintsUsed >= hints.length){ alert('Sem mais dicas.'); return; }
  hintsUsed++;
  currentHintEl.textContent = hints[hintsUsed-1] || '—';
  currentCardPoints = computePoints();
  hintsUsedEl.textContent = hintsUsed;
  cardPointsEl.textContent = currentCardPoints;
}
function revealWord(){
  if(!currentCard) return alert('Gire o dado primeiro.');
  if(currentCard.type === 'special'){ alert('Carta especial — não há "revelar palavra".'); return; }
  // reveal by showing correct word in currentHint and set points to 0
  currentHintEl.textContent = `Resposta: ${currentCard.word || '—'}`;
  currentCardPoints = 0;
  hintsUsed = currentCard.hints ? currentCard.hints.length : 0;
  hintsUsedEl.textContent = hintsUsed;
  cardPointsEl.textContent = currentCardPoints;
  log(`${players[currentPlayerIndex].name} revelou a palavra (0 pts).`);
  setTimeout(nextTurn,700);
}

/* compute points (based on hintsUsed) */
function computePoints(){ const used = Math.max(1, hintsUsed || 1); return POINT_MAP[Math.min(used-1, POINT_MAP.length-1)]; }

/* Aplica efeitos das cartas especiais (mesma lógica da versão anterior) */
function applySpecialEffect(card, answeredCorrectly){
  const player = players[currentPlayerIndex];
  const eff = card.effect || {};
  const kind = eff.kind;
  if(kind === 'instant'){
    player.score += eff.value || 0;
    log(`${player.name} recebeu ${eff.value} pts (efeito instantâneo).`);
    checkVictory(player);
    setTimeout(nextTurn,700);
    return;
  }
  if(kind === 'map_memory' && answeredCorrectly){
    const raw = prompt('Escolha uma cor: Roxo, Laranja, Verde, Azul', 'Roxo') || 'Roxo';
    const pick = raw.trim().toLowerCase();
    const mapping = {'roxo':0,'laranja':1,'verde':2,'azul':3};
    const pickIdx = mapping[pick];
    if(pickIdx === undefined){ alert('Escolha inválida — efeito cancelado.'); setTimeout(nextTurn,400); return; }
    log(`${player.name} escolheu a cor ${pick} para MAPA COM MEMÓRIA.`);
    players.forEach((p,i)=>{
      const face = Math.floor(Math.random()*6);
      showDieFace(face);
      log(`${p.name} rolou (evento MAP) → ${faceLabel(face)}`);
      if(face === pickIdx){
        if(p === player){
          p.score += eff.winValue;
          log(`${p.name} (respondente) ganhou +${eff.winValue} pts.`);
        } else {
          p.score += eff.loseValue;
          log(`${p.name} perdeu ${Math.abs(eff.loseValue)} pts.`);
        }
      }
    });
    renderPlayers();
    setTimeout(nextTurn,700);
    return;
  }
  if(kind === 'first_green_penalty' && answeredCorrectly){
    log(`Ativando OBJETO LIBERTADOR: outros jogadores rolam até alguém tirar VERDE; primeiro a tirar VERDE perde ${Math.abs(eff.penalty)} pts.`);
    const others = players.map((p,i)=>({p,i})).filter(o=>o.i !== currentPlayerIndex);
    if(others.length === 0){ log('Sem outros jogadores. Efeito sem alvo.'); setTimeout(nextTurn,700); return; }
    let found=false; let rounds=0;
    while(!found && rounds < 200){
      for(const o of others){
        rounds++;
        const face = Math.floor(Math.random()*6);
        showDieFace(face);
        log(`${o.p.name} rolou (tenta #${rounds}) → ${faceLabel(face)}`);
        if(face === 2){
          o.p.score += eff.penalty;
          log(`${o.p.name} tirou VERDE primeiro e recebeu ${eff.penalty} pts.`);
          found = true;
          break;
        }
      }
    }
    if(!found) log('Ninguém tirou VERDE dentro do limite. Efeito cancelado.');
    renderPlayers();
    setTimeout(nextTurn,700);
    return;
  }
  if(kind === 'color_effect' && answeredCorrectly){
    const face = Math.floor(Math.random()*4);
    showDieFace(face);
    const mapping = eff.mapping || {};
    const action = mapping[face];
    log(`${player.name} ativou LUZ DA RESISTÊNCIA e rolou cor ${faceLabel(face)}.`);
    if(!action){ log('Nenhuma ação definida para essa cor.'); setTimeout(nextTurn,700); return; }

    if(action.type === 'penalize_other'){
      const name = prompt(`Roxo: escolha alguém para perder ${Math.abs(action.value)} pts (digite o nome)`);
      const target = players.find(p=>p.name.toLowerCase() === (name||'').toLowerCase());
      if(target){ target.score += action.value; log(`${target.name} perdeu ${Math.abs(action.value)} pts.`); }
      else { const idx = (currentPlayerIndex + 1) % players.length; players[idx].score += action.value; log(`${players[idx].name} (padrão) perdeu ${Math.abs(action.value)} pts.`); }
    } else if(action.type === 'swap_with_leader'){
      let leaderIdx = null; let best = -Infinity;
      players.forEach((p,i)=>{ if(i!==currentPlayerIndex && p.score > best){ best=p.score; leaderIdx=i; }});
      if(leaderIdx !== null){
        const tmp = players[leaderIdx].score;
        players[leaderIdx].score = players[currentPlayerIndex].score;
        players[currentPlayerIndex].score = tmp;
        log(`${player.name} trocou pontuação com ${players[leaderIdx].name}.`);
      } else log('Nenhum jogador para trocar.');
    } else if(action.type === 'gain_self'){
      player.score += action.value;
      log(`${player.name} ganhou +${action.value} pts (Verde).`);
      checkVictory(player);
    } else if(action.type === 'lose_turn'){
      const name = prompt('Azul: escolha alguém para perder a vez (digite o nome)');
      const idx = players.findIndex(p=>p.name.toLowerCase() === (name||'').toLowerCase());
      if(idx >= 0){ players[idx].lostTurn = true; log(`${players[idx].name} perderá a próxima vez.`); }
      else { const fallback = (currentPlayerIndex+1) % players.length; players[fallback].lostTurn = true; log(`${players[fallback].name} (padrão) perderá a próxima vez.`); }
    }
    renderPlayers();
    setTimeout(nextTurn,700);
    return;
  }

  log('Carta especial processada (padrão).');
  setTimeout(nextTurn,700);
}

/* helpers e fluxo de turno */
function askHint(){ if(!currentCard) return alert('Gire o dado antes.'); if(currentCard.type==='special'){ alert('Cartas especiais não têm dicas sequenciais. Responda pela alternativa.'); return; } const hints = currentCard.hints || []; if(hintsUsed >= hints.length){ alert('Sem mais dicas.'); return; } hintsUsed++; currentHintEl.textContent = hints[hintsUsed-1] || '—'; currentCardPoints = computePoints(); hintsUsedEl.textContent = hintsUsed; cardPointsEl.textContent = currentCardPoints; }
function revealWord(){ if(!currentCard) return alert('Gire o dado primeiro.'); if(currentCard.type==='special'){ alert('Carta especial — não há revelar.'); return; } currentHintEl.textContent = `Resposta: ${currentCard.word || '—'}`; currentCardPoints = 0; hintsUsed = currentCard.hints ? currentCard.hints.length : 0; hintsUsedEl.textContent = hintsUsed; cardPointsEl.textContent = currentCardPoints; log(`${players[currentPlayerIndex].name} revelou (0 pts).`); setTimeout(nextTurn,700); }
function computePoints(){ const used = Math.max(1, hintsUsed || 1); return POINT_MAP[Math.min(used-1, POINT_MAP.length-1)]; }
function nextTurn(){ if(!gameActive) return; currentCard = null; hintsUsed = 0; currentCardPoints = 0; optionsLocked = false; currentPlayerIndex = (currentPlayerIndex + 1) % players.length; updateStatus(); log(`Vez de ${players[currentPlayerIndex].name}.`); }
function updateStatus(){ const cur = players[currentPlayerIndex]; turnLabel.textContent = cur ? cur.name : '—'; scoreLabel.textContent = cur ? cur.score : '—'; hintsUsedEl.textContent = hintsUsed; cardPointsEl.textContent = currentCardPoints; if(!currentCard){ cardTitle.textContent = '—'; cardMeta.textContent = 'Gire o dado para escolher tema e tirar uma carta.'; currentHintEl.textContent = '—'; optionsEl.innerHTML = ''; guessArea.style.display = 'none'; } renderPlayers(); renderScoreboard(); }
function startNewGame(){ if(players.length === 0) return alert('Adicione ao menos um jogador antes de iniciar.'); players.forEach(p=>{ p.score = 0; p.lostTurn = false; }); currentPlayerIndex = 0; gameActive = true; currentCard = null; hintsUsed = 0; currentCardPoints = 0; optionsLocked = false; loadAllCards(); renderPlayers(); log('Nova partida iniciada.'); updateStatus(); }
function endGame(){ gameActive = false; alert('Partida encerrada.'); }
function clearCardDisplay(){ cardTitle.textContent='—'; cardMeta.textContent='—'; currentHintEl.textContent='—'; optionsEl.innerHTML=''; guessArea.style.display='none'; hintsUsedEl.textContent='0'; cardPointsEl.textContent='0'; }
function faceLabel(face){ if(face>=0 && face<=3) return THEMES[face].label; if(face===4) return 'PERDE A VEZ'; return 'ESCOLHA SEU TEMA'; }
function checkVictory(player){ if(player.score >= GOAL){ player.score = GOAL; renderPlayers(); alert(`${player.name} atingiu ${GOAL} pts e venceu!`); gameActive=false; } }

/* tolerant match (normalize + levenshtein) for normal card guesses */
function normalizeText(s){ return String(s).normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^\w\s]/g,'').toLowerCase().trim(); }
function levenshtein(a,b){ const m=a.length,n=b.length; const dp=Array.from({length:m+1},()=>Array(n+1).fill(0)); for(let i=0;i<=m;i++)dp[i][0]=i; for(let j=0;j<=n;j++)dp[0][j]=j; for(let i=1;i<=m;i++){ for(let j=1;j<=n;j++){ const cost = a[i-1]===b[j-1]?0:1; dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost); }} return dp[m][n]; }
function tolerantMatch(a,b){ const A=normalizeText(a), B=normalizeText(b); if(!B) return false; if(A===B) return true; if(A.includes(B) || B.includes(A)) return true; const dist = levenshtein(A,B); const tol = Math.max(1, Math.floor(B.length * 0.25)); return dist <= tol; }

/* inicialização */
loadAllCards();
updateStatus();
log('Jogo pronto. Adicione jogadores e clique em "Nova partida".');

</script>
</body>
</html>
